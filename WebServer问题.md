# WebServer的一些相关问题：

### 一、项目介绍  listen  accept  bind 

- 使用线程池 + 非阻塞socket + epoll(ET和LT均实现) + 事件处理(Reactor和模拟Proactor均实现) 的并发模型；

- 使用状态机解析HTTP请求报文，支持解析GET和POST请求；

- 访问服务器数据库实现web端用户注册、登录功能，可以请求服务器图片和视频文件；

- 实现同步/异步日志系统，记录服务器运行状态；
- 实现定时监测非活跃连接机制，用于及时释放系统资源。

- 经Webbench压力测试可以实现上万的并发连接数据交换；

### 二、线程池相关：

#### 1.线程的同步机制有哪些？

- 信号量、条件变量、互斥锁等

####  2.线程池中的工作线程是一直等待吗？

- 是的，一直在等待被唤醒。

#### 3.线程池工作线程处理完一个任务后的状态是什么？

- 如果请求任务队列为空，则线程进入线程池中等待，如果请求队列不为空，则与其他线程一起竞争请求队列的任务。

#### 4.如果同时1000个客户端进行访问请求，线程数不多，怎么能及时响应处理每一个呢？

- 该项目基于I/O复用的并发模式，需要注意的是，不是一个客户连接对应一个线程。当有请求连接有事件到来的时候，epoll就会进行事件提醒，而后将对应的任务加入到请求队列，等待工作线程的竞争执行。如果速度还是比较慢的话，可以考虑增加线程池容量。

#### 5.如果一个客户请求需要占用线程很久的时间，会不会影响接下来的客户请求呢，有什么好的策略呢?

- 会的，因为线程池的线程数量是固定的，如果一个客户请求长时间占用着现成资源，势必会影响到服务器对外的一个整体响应速度。解决方面，可以考虑为每个线程处理任务设定一个时间阈值，当某个请求任务执行时间过长，则将任务置于请求队列的尾部，或者断开当前连接。

### 三、并发模型相关：

#### 1.简单说下服务器使用的并发模型？  请求封装，加入线程池请求队列，睡眠的线程拿到    任务 就运行任务  的解析函数，并生成响应 ，写入socket     

- 以模拟Proactor模式为例的工作流程：
  1.  主线程充当异步线程，负责监听所有socket上的事件
  2. 如果当前有新的客户端连接请求，主线程接收到新的连接请求得到新的socket连接，然后在epoll内核时间表注册该socket上的读写事件。
  3. 如果socket连接上有读写事件发生，主线程会对socket上读写数据，并将数据封装成请求对象插入到请求队列中。
  4. 所有的业务逻辑处理线程睡眠在请求队列上，当有任务到来时，通过竞争（如互斥锁）获得任务的所有权，并进行处理。

#### 2. Reactor、Proactor、主从Proactor模式的区别？

- Reactor模式：

  要求主线程（I/O处理单元）只负责监听文件描述符上是否有事件（读/写）发生。若有，则立即通知工作线程，将socket事件放入请求队列，**读写事件、接受新的连接以及处理连接请求逻辑处理均在工作线程中完成。（需要区别处理读 和 写事件）。**

- Proactor模式：

​		主线程和内核负责处理读写数据、接受新连接等I/O操作，工作线程仅负责业务逻辑处理，如处理客户连接请求等。

- 主从Proactor模式：

​		主反应堆线程只负责分发Acceptor连接建立，已连接socket上的I/O事件交给 sub-reactor负责分发。其中sub-reactor的数量，可以根据cpu的核心数灵活设置。工作流程如下：

<img src="https://devil-picture-bed.oss-cn-shenzhen.aliyuncs.com/image/202207282001379.png" alt="image-20220728200130158" style="zoom: 67%;" />

​		主反应堆线程一直在感知连接建立的事件，如果有连接成功建立，主反应堆线程通过accept方法获取建立连接的socket，接下来会按照一定的算法选取一个从反应堆线程，并把已经accept的socket加入到选择的从反应堆线程。主反应堆唯一的工作，就是调用accept获取建立连接的套接字，并将已连接的socket加入到从反应堆线程中。

#### 3. 你用了epoll，说一下为什么用epoll，还有其他复用方式吗？区别是什么？  

比较常用的I/O复用方式有select，poll， epoll。本项目采用epoll有以下几点原因：

- 对于select 和poll来说，所有的文件描述符fd都是在用户态下被加入其文件描述符集合的，**每次调用都需要将整个文件描述符集合拷贝到内核态**；而epoll则是将整个文件描述符集合维护在内核态，每次添加文件描述符的时候都需要 **执行一个系统调用**。系统调用的开销是很大的，而且在有很多短期活跃连接的情况下，epoll可能会慢于select和poll，由于这些大量的系统调用开销。
- select使用线性表描述文件描述符集合，**文件描述符有上限限制**；poll**使用链表来描述**；epoll底层通过 **红黑树**来描述，并且维护一个 **ready_list**，将事件表上已经就绪的事件添加到这里，在使用epoll_wait系统调用时，仅需判断 **ready_list** 是否存在数据即可。
- select和epoll的最大开销来自于内核判断是否有文件描述符存在就绪事件这一过程；每次执行select或者poll调用的时候，**它们会采用遍历的方式**，遍历整个文件描述符集合来判断是否存在就绪事件；epoll则不需要遍历，当有就绪事件产生时，会自动触发epoll回调函数通知epoll有就绪事件的文件描述符，然后内核将这些就绪的文件描述符放到 **ready_list** 中，等到 epoll_wait 系统调用后被处理。
- select和poll都只能工作在相对低效的LT模式下，而epoll同时支持LT和ET模式。
- 综上，当并发连接数量较少时，且各个连接相对活跃的情况下，建议使用select和poll方式，当并发连接数量较多，且单位时间内仅部分连接相对活跃的情况下，使用epoll会明显提升性能。



### 四、HTTP报文解析相关

#### 1.为什么要用状态机进行解析？

- 有限状态机，是一种抽象的理论模型，它能够把有限个变量描述的状态变化过程，以可构造可验证的方式呈现出来。比如，封闭的有向图，有限状态机可以通过if-else，swith-case和函数指针来实现，从工程的角度来看，主要是为了封装逻辑。有限状态机是一种逻辑单元内部的一种高效变成方法，在服务器编程中，服务器可以根据不同的状态或者消息类型进行相应的逻辑处理，使得程序逻辑清晰易懂。

#### 2. 状态机转移图大概是什么样的？

- 如图：![image-20220728203818611](https://devil-picture-bed.oss-cn-shenzhen.aliyuncs.com/image/202207282038696.png)

#### 3. https协议为什么是安全的？

- 连接建立阶段基于SSL安全验证；数据传输阶段也加密处理。

#### 4. https 的SSL连接过程？

- 如图：![](https://devil-picture-bed.oss-cn-shenzhen.aliyuncs.com/image/202207282041334.png)

#### 5. GET和POST的区别？

- 



### 五、数据库登陆注册相关

#### 1. 登陆过程？

- 涉及到载入数据库表，提取用户名和密码，注册登陆流程与页面跳转。
  - 载入数据库表，结合代码将数据库中的数据载入到服务器中。
  - 提取用户名和密码，结合代码对报文进行解析，提取用户名和密码。
  - 注册登陆流程，结合代码对描述服务器进行注册和登陆校验的流程。
  - 页面跳转，结合代码对页面跳转机制进行详解。

#### 2. 你这个可以保存状态吗？如果要保存，要怎么做？

- 可以利用session 或者 cookie的方式进行状态的保存。
  - cookie其实就是服务器给客户端分配的一串”身份标识”，比如“1235sdsfg2s”这么一串字符串。每次客户发送数据的时候，都在HTTP报文附带上这个字符串，服务器就知道你是谁了。
  - session 是保存在服务端的状态，每当一个客户发送HTTP报文过来的时候，服务器就会在自己记录的用户数据中去查找是否有相关记录。

#### 3. 登陆中的用户名和密码，你是load到本地，然后使用map匹配的，如果有10e数据，即使load本地后hash，还是很耗时，你要怎么优化？

- 这个问题的关键在于大数据量的情况下的用户登陆验证怎么进行？ 将所有的用户信息加载到内存中耗时耗力，对于大数据最普遍的方法就是进行hash，利用hash建立所及索引的方式来加快用户验证。具体操作如下：
  - 首先，将10e的用户信息，利用大致缩小1000倍的hash算法进行hash，就获得了100w的hash数据，每个hash数据代表着一个**用户信息块（一级）**
  - 然后，在分别对100w的hash数据进行再hash，例如最终剩下1000个hash的**数据（二级）**
  - 这种情况下，服务器端只需要保存1000个二级hash的珊瑚橘，当用户请求登陆的时候，先对用户信息进行一次hash，找到对应的数据块（二级），然后读取其对应的一级信息块，再次hash，找到对应的最终用户数据。

#### 4. 用过mysql吗？ redis了解吗？

### 六、定时器相关

#### 1. 为什么需要定时器？

- 用于处理定时任务，定期检测关闭非活跃的连接，节省系统资源。

#### 2. 说一下定时器的工作原理？

- 服务器为各个事件连接分配一个定时器。项目中使用了SIGALARM信号来触发定时器，首先每一个定时器时间节点都处于在一个升序链表上，通过alarm（）函数周期性的触发**ALARM信号**，而后信号处理函数利用管道通知主循环**ALARM信号**的到来，主循环收到信号之后，调用trick函数用于处理升序链表上的过期定时器时间节点。

#### 3. 双向链表的删除和添加的时间复杂度说一下？ 还可以优化吗？

- 添加一般情况下为O(1)，删除为O(1)。优化方便，可以考虑采用最小堆来进行优化。

#### 4. 最小堆优化？说一下时间复杂度和工作原理？

- 最小堆以每个定时器的过期时间进行小根堆排序，过时期间最早的定时器节点位于堆顶，当主线程收到ALARM信号的触发时，调用trick()函数执行 **过期的定时器节点** 的清楚，如果堆顶节点过期，则进行删除，并更新最小堆，然后再判断堆顶是否过期，直到堆顶元素未过期为止。
- 插入复杂度为一次调整，O($logn$)； 删除为一次调整，复杂度 O($logn$);

### 七、日志相关

#### 1. 说一下你的日志系统运行机制？

- 服务器启动的时候，采用单例模式初始化日志系统，根据配置确定使用同步/异步日志写入方式。

#### 2. 为什么要异步？ 和同步的区别是什么？

- 同步方式写入日志时，由于会产生比较多的系统调用，如果某些日志信息过大， 会阻塞日志系统造成系统瓶颈。
- 异步方式采用生产者-消费者模型，使用异步日志线程单独用于将日志写入文件，具有较高的并发能力。

#### 3. 如果你要监控一台服务器的状态，输出监控日志，请问如何将日志分发到不同的机器上？

- 为了便于排查故障，或服务器状态分析，看是否需要维护，可以使用消息队列进行信息的分发。

### 八、压力测试相关

#### 1. 服务器并发量测试过吗？怎么测试的？  size 实际存放数据大小

- 测试过，利用webbench，满足上万的并发量。       是压测那个返回时间吗？

#### 2. webbench是什么？介绍一下原理？

- webbench是一款轻量级的网址压力测试工具，最高可以实现3W的并发测试。
- 核心原理：父进程通过fork若干个子进程，每个子进程在用户要求时间或者默认时间内对目标web循环发出实际的访问请求，父子进程通过管道进行通信，子进程通过管道写端向父进程传递在若干次请求访问完毕后记录到的总信息，父进程通过管道的读端读取子进程发来的相关信息，子进程在时间到后结束，父进程在所有子进程退出后统计并给用户显示最后的测试结果，然后退出程序。

#### 3. 测试的时候有遇到什么问题吗？

- 增加定时器清理连接的时候，定时器和http请求对象写在两个不同的头文件，引发循环引用的问题。（写在一个头文件内，暂时解决，后期计划使用智能指针重写）

### 九、综合能力

#### 1. 你的项目有什么亮点？

- 自己造轮子。。。。

#### 2. 说一下前端发送请求后，服务器的处理过程，中间涉及到 哪些协议？

- HTTP协议，TCP协议，IP协议等。计网相关













